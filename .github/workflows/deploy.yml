name: ðŸ“š æž„å»ºä¸Žéƒ¨ç½²æ–‡æ¡£

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  docs:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ èŽ·å– Node/npm ç‰ˆæœ¬
        id: npm-version
        run: |
          echo "::group::ðŸ” æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯"
          VERSION=$(grep -o 'npm@[0-9\.]*' package.json | cut -d@ -f2)
          echo "npm_version=$VERSION" >> $GITHUB_ENV
          echo "node_version=$(node -v | cut -dv -f2)" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: ðŸ§° è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.node_version || '22' }}
          cache: npm
          cache-dependency-path: '**/package-lock.json'

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "::group::ðŸ“¦ æ­£åœ¨å®‰è£… npm ä¾èµ–..."
          npm ci
          echo "::endgroup::âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ðŸ—ï¸ æž„å»º VuePress é¡¹ç›®
        run: |
          echo "::group::ðŸ”§ VuePress æž„å»ºä¸­..."
          npm run docs:build
          echo "::endgroup::âœ… VuePress æž„å»ºå®Œæˆ"

      - name: ðŸ å®‰è£… Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: ðŸš€ æŽ¨é€é“¾æŽ¥åˆ° IndexNow
        run: |
          echo "::group::ðŸ“¤ æŽ¨é€ IndexNow..."
          pip install requests
          URL_COUNT=$(python .github/scripts/push_to_indexnow.py | tee /tmp/indexnow.log | grep -Eo "[0-9]+ ä¸ªé“¾æŽ¥" | grep -Eo "[0-9]+" || echo "0")
          echo "url_count=$URL_COUNT" >> $GITHUB_ENV
          echo "::endgroup::âœ… æŽ¨é€å®Œæˆ"
        continue-on-error: true

      - name: ðŸ“ å†™å…¥æž„å»ºæ‘˜è¦
        run: |
          echo "### âœ… æ–‡æ¡£æž„å»ºä¸Žéƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- æž„å»ºæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- æŽ¨é€åˆ° IndexNow çš„é“¾æŽ¥æ•°ï¼š${{ env.url_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ æ–‡æ¡£éƒ¨ç½²åœ°å€ï¼š[manual.njust.wiki](https://manual.njust.wiki)" >> $GITHUB_STEP_SUMMARY

      - name: ðŸšš éƒ¨ç½²åˆ° GitHub Pages
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: gh-pages
          build_dir: docs/.vuepress/dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
