name: ðŸ“š æž„å»ºä¸Žéƒ¨ç½²æ–‡æ¡£

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  build_docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      issues: write

    steps:
      # ------------------------
      # æ£€å‡ºä»£ç 
      # ------------------------
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------
      # Node.js çŽ¯å¢ƒ
      # ------------------------
      - name: ðŸ§° è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm

      # ------------------------
      # å®‰è£…ä¾èµ–
      # ------------------------
      - name: ðŸ“¦ å®‰è£… Node.js ä¾èµ–
        run: |
          echo "::group::ðŸ“¦ å®‰è£…ä¾èµ–..."
          npm ci
          echo "::endgroup::âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # ------------------------
      # æž„å»º VuePress
      # ------------------------
      - name: ðŸ—ï¸ æž„å»º VuePress é¡¹ç›®
        run: npm run docs:build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------
      # æž„å»ºç»Ÿè®¡ä¿¡æ¯
      # ------------------------
      - name: ðŸ“Š æ”¶é›†æž„å»ºç»Ÿè®¡ä¿¡æ¯
        id: build_stats
        run: |
          NODE_VER=$(node -v)
          NPM_VER=$(npm -v)
          OS_INFO=$(uname -a)
          CPU_MODEL=$(lscpu | grep "Model name" | sed 's/Model name:\s*//')
          CPU_CORES=$(nproc)
          MEM_TOTAL=$(grep MemTotal /proc/meminfo | awk '{print $2/1024 " MB"}')
          DISK_TOTAL=$(df -h / | awk 'NR==2 {print $2}')

          BUILD_SIZE=$(du -sh docs/.vuepress/dist | cut -f1)
          PAGE_COUNT=$(find docs/.vuepress/dist -type f -name "*.html" | wc -l)

          echo "node_ver=$NODE_VER" >> $GITHUB_OUTPUT
          echo "npm_ver=$NPM_VER" >> $GITHUB_OUTPUT
          echo "os_info=$OS_INFO" >> $GITHUB_OUTPUT
          echo "cpu_model=$CPU_MODEL" >> $GITHUB_OUTPUT
          echo "cpu_cores=$CPU_CORES" >> $GITHUB_OUTPUT
          echo "mem_total=$MEM_TOTAL" >> $GITHUB_OUTPUT
          echo "disk_total=$DISK_TOTAL" >> $GITHUB_OUTPUT
          echo "build_size=$BUILD_SIZE" >> $GITHUB_OUTPUT
          echo "page_count=$PAGE_COUNT" >> $GITHUB_OUTPUT

      # ------------------------
      # å¤šçº¿ç¨‹æ­»é“¾æ£€æµ‹
      # ------------------------
      - name: ðŸ”— æ£€æŸ¥æ–‡æ¡£é“¾æŽ¥
        id: check_links
        run: |
          echo "::group::ðŸ”— æ£€æŸ¥æ–‡æ¡£é“¾æŽ¥..."
          node .github/workflows/scripts/check-links.js docs/.vuepress/dist 100 false | tee check-links.log
          echo "::endgroup::"
        continue-on-error: true

      # ------------------------
      # å†™å…¥æž„å»ºæ‘˜è¦
      # ------------------------
      - name: ðŸ“ å†™å…¥æž„å»ºæ‘˜è¦
        run: |
          echo "## ðŸš€ æ–‡æ¡£æž„å»ºä¸Žéƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å®ŒæˆçŠ¶æ€ï¼š** âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "**æž„å»ºæ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- æž„å»ºç›®å½•å¤§å°ï¼š${{ steps.build_stats.outputs.build_size }}" >> $GITHUB_STEP_SUMMARY
          echo "- HTML é¡µé¢æ•°é‡ï¼š${{ steps.build_stats.outputs.page_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ–¥ï¸ æž„å»ºæœºå™¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- CPU åž‹å·ï¼š${{ steps.build_stats.outputs.cpu_model }}" >> $GITHUB_STEP_SUMMARY
          echo "- CPU æ ¸å¿ƒæ•°ï¼š${{ steps.build_stats.outputs.cpu_cores }}" >> $GITHUB_STEP_SUMMARY
          echo "- å†…å­˜æ€»é‡ï¼š${{ steps.build_stats.outputs.mem_total }}" >> $GITHUB_STEP_SUMMARY
          echo "- ç£ç›˜æ€»é‡ï¼š${{ steps.build_stats.outputs.disk_total }}" >> $GITHUB_STEP_SUMMARY
          echo "- ç³»ç»Ÿä¿¡æ¯ï¼š${{ steps.build_stats.outputs.os_info }}" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js ç‰ˆæœ¬ï¼š${{ steps.build_stats.outputs.node_ver }}" >> $GITHUB_STEP_SUMMARY
          echo "- NPM ç‰ˆæœ¬ï¼š${{ steps.build_stats.outputs.npm_ver }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” é“¾æŽ¥æ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          grep -E "âŒ|Ã—|\?" check-links.log >> $GITHUB_STEP_SUMMARY || echo "âœ… æœªæ£€æµ‹åˆ°é—®é¢˜é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY

      # ------------------------
      # éƒ¨ç½²åˆ° GitHub Pages
      # ------------------------
      - name: ðŸš€ éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/.vuepress/dist
