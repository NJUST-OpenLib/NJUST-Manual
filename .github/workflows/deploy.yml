name: ğŸ“š æ„å»ºä¸éƒ¨ç½²æ–‡æ¡£

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  build_docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      issues: write

    steps:
      # ------------------------
      # æ£€å‡ºä»£ç 
      # ------------------------
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------
      # Node.js ç¯å¢ƒ
      # ------------------------
      - name: ğŸ§° è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm

      # ------------------------
      # å®‰è£…ä¾èµ–
      # ------------------------
      - name: ğŸ“¦ å®‰è£… Node.js ä¾èµ–
        run: |
          echo "::group::ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm ci
          echo "::endgroup::âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # ------------------------
      # æ„å»º VuePress
      # ------------------------
      - name: ğŸ—ï¸ æ„å»º VuePress é¡¹ç›®
        run: npm run docs:build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------
      # æ„å»ºç»Ÿè®¡ä¿¡æ¯
      # ------------------------
      - name: ğŸ“Š æ”¶é›†æ„å»ºç»Ÿè®¡ä¿¡æ¯
        id: build_stats
        run: |
          NODE_VER=$(node -v)
          NPM_VER=$(npm -v)
          OS_INFO=$(uname -a)
          CPU_MODEL=$(lscpu | grep "Model name" | sed 's/Model name:\s*//')
          CPU_CORES=$(nproc)
          MEM_TOTAL=$(grep MemTotal /proc/meminfo | awk '{print $2/1024 " MB"}')
          DISK_TOTAL=$(df -h / | awk 'NR==2 {print $2}')

          BUILD_SIZE=$(du -sh docs/.vuepress/dist | cut -f1)
          PAGE_COUNT=$(find docs/.vuepress/dist -type f -name "*.html" | wc -l)

          {
            echo "node_ver=$NODE_VER"
            echo "npm_ver=$NPM_VER"
            echo "os_info=$OS_INFO"
            echo "cpu_model=$CPU_MODEL"
            echo "cpu_cores=$CPU_CORES"
            echo "mem_total=$MEM_TOTAL"
            echo "disk_total=$DISK_TOTAL"
            echo "build_size=$BUILD_SIZE"
            echo "page_count=$PAGE_COUNT"
          } >> "$GITHUB_OUTPUT"

      # ------------------------
      # å¤šçº¿ç¨‹æ­»é“¾æ£€æµ‹
      # ------------------------
      - name: ğŸ”— æ£€æŸ¥æ–‡æ¡£é“¾æ¥
        id: check_links
        run: |
          echo "::group::ğŸ”— æ£€æŸ¥æ–‡æ¡£é“¾æ¥..."
          node .github/workflows/scripts/check-links.js docs/.vuepress/dist 100 true | tee check-links.log
          echo "::endgroup::"
        continue-on-error: true

      # ------------------------
      # å†™å…¥æ„å»ºæ‘˜è¦
      # ------------------------
      - name: ğŸ“ å†™å…¥æ„å»ºæ‘˜è¦
        run: |
          cat << 'EOF' >> "$GITHUB_STEP_SUMMARY"
## ğŸš€ æ–‡æ¡£æ„å»ºä¸éƒ¨ç½²æŠ¥å‘Š

**å®ŒæˆçŠ¶æ€ï¼š** âœ… æˆåŠŸ  
**æ„å»ºæ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')  

### ğŸ“¦ æ„å»ºäº§ç‰©
- æ„å»ºç›®å½•å¤§å°ï¼š${{ steps.build_stats.outputs.build_size }}
- HTML é¡µé¢æ•°é‡ï¼š${{ steps.build_stats.outputs.page_count }}

### ğŸ–¥ï¸ æ„å»ºæœºå™¨ä¿¡æ¯
- CPU å‹å·ï¼š${{ steps.build_stats.outputs.cpu_model }}
- CPU æ ¸å¿ƒæ•°ï¼š${{ steps.build_stats.outputs.cpu_cores }}
- å†…å­˜æ€»é‡ï¼š${{ steps.build_stats.outputs.mem_total }}
- ç£ç›˜æ€»é‡ï¼š${{ steps.build_stats.outputs.disk_total }}
- ç³»ç»Ÿä¿¡æ¯ï¼š${{ steps.build_stats.outputs.os_info }}
- Node.js ç‰ˆæœ¬ï¼š${{ steps.build_stats.outputs.node_ver }}
- NPM ç‰ˆæœ¬ï¼š${{ steps.build_stats.outputs.npm_ver }}

### ğŸ” é“¾æ¥æ£€æŸ¥ç»“æœ
EOF
          grep -E "âŒ|Ã—|\?" check-links.log >> "$GITHUB_STEP_SUMMARY" || echo "âœ… æœªæ£€æµ‹åˆ°é—®é¢˜é“¾æ¥"

      # ------------------------
      # éƒ¨ç½²åˆ° GitHub Pages
      # ------------------------
      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/.vuepress/dist
