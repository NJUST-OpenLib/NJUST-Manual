name: ğŸ“š æ„å»ºä¸éƒ¨ç½²æ–‡æ¡£

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build_docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: â±ï¸ è®°å½•å¼€å§‹æ—¶é—´
        id: start_time
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§° è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm

      - name: ğŸ“¦ å®‰è£… Node.js ä¾èµ–
        run: |
          echo "::group::ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm ci
          echo "::endgroup::âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          
      - name: ğŸ—ï¸ æ„å»º VuePress é¡¹ç›®
        run: npm run docs:build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š æ”¶é›†æ„å»ºç»Ÿè®¡ä¿¡æ¯
        id: build_stats
        run: |
          # æäº¤ç»Ÿè®¡
          COMMIT_COUNT=$(git rev-list --count ${{ github.event.before }}..${{ github.sha }})
          ALL_COMMITS=$(git log ${{ github.event.before }}..${{ github.sha }} --pretty=format:"- ğŸ“ %s (%an)")

          # æ„å»ºç¯å¢ƒä¿¡æ¯
          NODE_VER=$(node -v)
          NPM_VER=$(npm -v)
          OS_INFO=$(uname -a)

          # æœºå™¨ç¡¬ä»¶ä¿¡æ¯
          CPU_MODEL=$(lscpu | grep "Model name" | sed 's/Model name:\s*//')
          CPU_CORES=$(nproc)
          MEM_TOTAL=$(grep MemTotal /proc/meminfo | awk '{print $2/1024 " MB"}')
          DISK_TOTAL=$(df -h / | awk 'NR==2 {print $2}')

          # æ„å»ºäº§ç‰©ç»Ÿè®¡
          BUILD_SIZE=$(du -sh docs/.vuepress/dist | cut -f1)
          PAGE_COUNT=$(find docs/.vuepress/dist -type f -name "*.html" | wc -l)

          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "all_commits<<EOF" >> $GITHUB_OUTPUT
          echo "$ALL_COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "node_ver=$NODE_VER" >> $GITHUB_OUTPUT
          echo "npm_ver=$NPM_VER" >> $GITHUB_OUTPUT
          echo "os_info=$OS_INFO" >> $GITHUB_OUTPUT
          echo "cpu_model=$CPU_MODEL" >> $GITHUB_OUTPUT
          echo "cpu_cores=$CPU_CORES" >> $GITHUB_OUTPUT
          echo "mem_total=$MEM_TOTAL" >> $GITHUB_OUTPUT
          echo "disk_total=$DISK_TOTAL" >> $GITHUB_OUTPUT
          echo "build_size=$BUILD_SIZE" >> $GITHUB_OUTPUT
          echo "page_count=$PAGE_COUNT" >> $GITHUB_OUTPUT

      - name: ğŸ” æ£€æŸ¥ 404 é“¾æ¥
        id: link_check
        uses: lycheeverse/lychee-action@v1.9.0
        with:
          args: --base docs/.vuepress/dist --recursive --verbose --no-progress --accept 200,302 .
        continue-on-error: true

      - name: ğŸš€ æ¨é€é“¾æ¥åˆ°æœç´¢å¼•æ“
        id: push_urls
        run: |
          node .github/workflows/scripts/push_to_indexnow.js | tee /dev/stdout | grep "urls_count" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ“ å†™å…¥æ„å»ºæ‘˜è¦
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - ${{ steps.start_time.outputs.start_time }}))

          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## ğŸš€ æ–‡æ¡£æ„å»ºä¸éƒ¨ç½²æŠ¥å‘Š
          **å®ŒæˆçŠ¶æ€ï¼š** âœ… æˆåŠŸ  
          **æ„å»ºæ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')  
          **æ€»è€—æ—¶ï¼š** ${DURATION}s  
          **æ¨é€é“¾æ¥æ•°ï¼š** ${{ steps.push_urls.outputs.urls_count }}  

          ### ğŸ“¦ æ„å»ºäº§ç‰©
          - æ„å»ºç›®å½•å¤§å°ï¼š${{ steps.build_stats.outputs.build_size }}
          - HTML é¡µé¢æ•°é‡ï¼š${{ steps.build_stats.outputs.page_count }}

          ### ğŸ“œ æäº¤ä¿¡æ¯
          - æœ¬æ¬¡æäº¤æ•°é‡ï¼š${{ steps.build_stats.outputs.commit_count }}
          ${{ steps.build_stats.outputs.all_commits }}

          ### ğŸ–¥ï¸ æ„å»ºæœºå™¨ä¿¡æ¯
          - CPU å‹å·ï¼š${{ steps.build_stats.outputs.cpu_model }}
          - CPU æ ¸å¿ƒæ•°ï¼š${{ steps.build_stats.outputs.cpu_cores }}
          - å†…å­˜æ€»é‡ï¼š${{ steps.build_stats.outputs.mem_total }}
          - ç£ç›˜æ€»é‡ï¼š${{ steps.build_stats.outputs.disk_total }}
          - ç³»ç»Ÿä¿¡æ¯ï¼š${{ steps.build_stats.outputs.os_info }}
          - Node.js ç‰ˆæœ¬ï¼š${{ steps.build_stats.outputs.node_ver }}
          - NPM ç‰ˆæœ¬ï¼š${{ steps.build_stats.outputs.npm_ver }}

          ### ğŸ” é“¾æ¥æ£€æŸ¥ç»“æœ
          EOF
          if [ -f lychee-report.md ]; then
            cat lychee-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… æœªæ£€æµ‹åˆ° 404 é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/.vuepress/dist
